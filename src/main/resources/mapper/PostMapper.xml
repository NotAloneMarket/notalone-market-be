<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ddwu.notalonemarket.mapper.PostMapper">
    <insert id="insertPost" parameterType="com.ddwu.notalonemarket.domain.Post" keyProperty="id">
    
    <!-- 시퀀스에서 ID 미리 받아오기 -->
    <selectKey resultType="long" order="BEFORE" keyProperty="id">
        SELECT seq_post.NEXTVAL FROM dual
    </selectKey>

    INSERT INTO Post (
        id, title, description, total_amount, total_quantity, my_quantity,
        price_per_item, participant_limit, product_url, image_url,
        status, category_id, writer_id
    ) VALUES (
        #{id}, #{title}, #{description}, #{totalAmount}, #{totalQuantity}, #{myQuantity},
        #{pricePerItem}, #{participantLimit}, #{productUrl}, #{imageUrl},
        #{status, jdbcType=VARCHAR}, #{categoryId}, #{writerId}
    )
</insert>


    <resultMap id="postResultMap" type="com.ddwu.notalonemarket.domain.Post">
	    <id property="id" column="id"/>
	    <result property="title" column="title"/>
	    <result property="description" column="description"/>
	    <result property="totalAmount" column="total_amount"/>
	    <result property="totalQuantity" column="total_quantity"/>
	    <result property="myQuantity" column="my_quantity"/>
	    <result property="pricePerItem" column="price_per_item"/>
	    <result property="participantLimit" column="participant_limit"/>
	    <result property="productUrl" column="product_url"/>
	    <result property="imageUrl" column="image_url"/>
	    <result property="status" column="status"/>
	    <result property="categoryId" column="category_id"/>
	    <result property="writerId" column="writer_id"/>
	</resultMap>
	
	<select id="selectAllSellingPosts" resultMap="postResultMap">
	    SELECT * FROM Post WHERE status = 'SELLING'
	</select>
	
	<select id="selectPostById" resultMap="postResultMap">
	    SELECT * FROM Post WHERE id = #{id}
	</select>
	
	 <select id="selectPostsByKeyword" parameterType="string" resultMap="postResultMap">
	    SELECT * FROM Post
	    WHERE status = 'SELLING'
	      AND (
	        LOWER(title) LIKE '%' || LOWER(#{keyword}) || '%'
	        OR LOWER(description) LIKE '%' || LOWER(#{keyword}) || '%'
	      )
	</select>


    <select id="selectPostsByCategory" parameterType="string" resultMap="postResultMap">
	  SELECT p.*
	  FROM Post p
	  JOIN Category c ON p.category_id = c.id
	  WHERE c.name = #{category}
	    AND p.status = 'SELLING'
	</select>



    <select id="selectPostsByWriterId" parameterType="long" resultMap="postResultMap">
        SELECT * FROM Post
        WHERE writer_id = #{writerId}
    </select>

</mapper>
